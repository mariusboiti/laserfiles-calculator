# Multi-stage Dockerfile for NestJS API (apps/api)
# Build with pnpm workspace from monorepo root

FROM node:22-alpine AS base

# Enable pnpm via corepack
ENV PNPM_HOME="/usr/local/share/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

WORKDIR /app

# ------------------------
# Stage 1: install deps
# ------------------------
FROM base AS deps

# Workspace manifests
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json tsconfig.base.json ./

# App and workspace package manifests (for better caching)
COPY apps/api/package.json apps/api/package.json
COPY apps/web/package.json apps/web/package.json
COPY packages/shared/package.json packages/shared/package.json
COPY packages/pricing-engine/package.json packages/pricing-engine/package.json

# Install all workspace dependencies (dev + prod)
RUN pnpm install --frozen-lockfile

# ------------------------
# Stage 2: build API
# ------------------------
FROM deps AS build

# Copy full source tree
COPY . .

# Build only the API app (uses Nest build under the hood)
RUN pnpm --filter ./apps/api... build

# ------------------------
# Stage 3: runtime image
# ------------------------
FROM node:22-alpine AS api

ENV NODE_ENV="production"
ENV PNPM_HOME="/usr/local/share/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

WORKDIR /app

# Copy node_modules for the whole workspace
COPY --from=deps /app/node_modules ./node_modules

# Copy workspace package manifests (needed for pnpm to resolve workspace: links)
COPY --from=deps /app/package.json ./package.json
COPY --from=deps /app/pnpm-workspace.yaml ./pnpm-workspace.yaml

# Copy built workspace packages
COPY --from=build /app/packages/shared/package.json ./packages/shared/package.json
COPY --from=build /app/packages/shared/dist ./packages/shared/dist
COPY --from=build /app/packages/pricing-engine/package.json ./packages/pricing-engine/package.json
COPY --from=build /app/packages/pricing-engine/dist ./packages/pricing-engine/dist

# Copy built API dist
COPY --from=build /app/apps/api/dist ./apps/api/dist

# (Optional) copy Prisma schema/migrations if you run migrations inside the container
COPY prisma ./prisma

# Expose Nest API port
EXPOSE 4000

# Start the API
# main.js entry is generated by Nest build; path matches "start" script in apps/api/package.json
CMD ["node", "apps/api/dist/apps/api/src/main.js"]
