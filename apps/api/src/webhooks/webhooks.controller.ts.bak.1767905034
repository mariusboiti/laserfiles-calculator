import {
  BadRequestException,
  Body,
  Controller,
  Headers,
  HttpCode,
  HttpStatus,
  Logger,
  Post,
  Req,
} from '@nestjs/common';
import type { Request } from 'express';
import { WebhooksService } from './webhooks.service';

@Controller('webhooks/wp')
export class WebhooksController {
  private readonly logger = new Logger(WebhooksController.name);

  constructor(private readonly webhooksService: WebhooksService) {}

  // Final URL: /webhooks/wp/billing (and behind nginx: /api-backend/webhooks/wp/billing)
  @Post('billing')
  @HttpCode(HttpStatus.OK)
  async handleWpBillingWebhook(
    @Req() req: Request & { rawBody?: Buffer },
    @Headers('x-wp-signature') wpSignature?: string,
    @Headers('x-wc-webhook-signature') wcSignature?: string,
    @Headers('x-wp-webhook-secret') wpSecretHeader?: string,
    @Headers('x-wp-secret') wpSecretHeaderAlt?: string,
    @Body() payload?: any,
  ) {
    // ---------------------------------------------------------------------
    // WooCommerce "ping" / test call when saving/enabling webhook (Hookshot)
    // - often application/x-www-form-urlencoded
    // - often no signature headers
    // We must return 200 OK with no side effects.
    // ---------------------------------------------------------------------
    const ct = String(req.headers['content-type'] ?? '');
    const ua = String(req.headers['user-agent'] ?? '');
    const hasAnyAuth =
      !!req.headers['x-wc-webhook-signature'] ||
      !!req.headers['x-wp-signature'] ||
      !!req.headers['x-wp-webhook-secret'] ||
      !!req.headers['x-wp-secret'];

    if (!hasAnyAuth && ct.includes('application/x-www-form-urlencoded') && ua.includes('Hookshot')) {
      this.logger.log('Woo webhook ping received (no signature) â€“ returning 200');
      return { ok: true, ping: true };
    }

    // Normal processing
    const signature = wpSignature || wcSignature;
    const secretHeader = wpSecretHeader || wpSecretHeaderAlt;

    // Allow either: shared-secret header OR signature header
    if (!signature && !secretHeader) {
      this.logger.warn(
        `Webhook received without signature/secret header | headers=${JSON.stringify(req.headers)}`,
      );
      // keep this line if you want it in logs exactly:
      // console.warn('HEADERS_AT_WARN=' + JSON.stringify(req.headers));
      throw new BadRequestException('Missing signature');
    }

    await this.webhooksService.processWpBillingWebhook({
      signature,
      webhookSecretHeader: secretHeader,
      rawBody: req.rawBody,
      body: payload,
    });

    return { ok: true };
  }
}

