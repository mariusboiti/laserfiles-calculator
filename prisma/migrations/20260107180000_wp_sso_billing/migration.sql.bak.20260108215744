-- CreateEnum
CREATE TYPE "SubscriptionType" AS ENUM ('MONTHLY', 'ANNUAL');

-- CreateEnum
CREATE TYPE "SubscriptionStatus" AS ENUM ('ACTIVE', 'CANCELLED');

-- AlterTable
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public'
      AND lower(table_name)=lower('User')
      AND lower(column_name)=lower('wpUserId')
  ) THEN
    DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public'
      AND table_name='User'
      AND column_name='wpUserId'
  ) THEN
    DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public'
      AND table_name='User'
      AND column_name='wpUserId'
  ) THEN
    DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM pg_attribute a
    JOIN pg_class c ON c.oid = a.attrelid
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE n.nspname = 'public'
      AND c.relname = 'User'
      AND a.attname = 'wpUserId'
      AND a.attisdropped = false
  ) THEN
    ALTER TABLE "User" ADD COLUMN "wpUserId" INTEGER;
  END IF;
END $$;

  END IF;
END $$;

  END IF;
END $$;

  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public'
      AND lower(table_name)=lower('User')
      AND lower(column_name)=lower('subscriptionType')
  ) THEN
    DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public'
      AND table_name='User'
      AND column_name='subscriptionType'
  ) THEN
    DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM pg_attribute a
    JOIN pg_class c ON c.oid = a.attrelid
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE n.nspname = 'public'
      AND c.relname = 'User'
      AND a.attname = 'subscriptionType'
      AND a.attisdropped = false
  ) THEN
    ALTER TABLE "User" ADD COLUMN "subscriptionType" "SubscriptionType";
  END IF;
END $$;

  END IF;
END $$;

  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public'
      AND lower(table_name)=lower('User')
      AND lower(column_name)=lower('subscriptionStatus')
  ) THEN
    DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public'
      AND table_name='User'
      AND column_name='subscriptionStatus'
  ) THEN
    DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM pg_attribute a
    JOIN pg_class c ON c.oid = a.attrelid
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE n.nspname = 'public'
      AND c.relname = 'User'
      AND a.attname = 'subscriptionStatus'
      AND a.attisdropped = false
  ) THEN
    ALTER TABLE "User" ADD COLUMN "subscriptionStatus" "SubscriptionStatus";
  END IF;
END $$;

  END IF;
END $$;

  END IF;
END $$;


-- CreateIndex
CREATE UNIQUE INDEX "User_wpUserId_key" ON "User"("wpUserId");

-- CreateTable
CREATE TABLE "WpWebhookEvent" (
    "id" TEXT NOT NULL,
    "eventId" TEXT NOT NULL,
    "payloadJson" JSONB NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "WpWebhookEvent_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "WpWebhookEvent_eventId_key" ON "WpWebhookEvent"("eventId");
