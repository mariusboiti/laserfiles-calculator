generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  WORKER
  SUPPORT
}

enum UserPlan {
  FREE
  PRO
  BUSINESS
}

enum SubscriptionType {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
}

enum UsageAction {
  EXPORT
}

enum OrderStatus {
  NEW
  IN_PROGRESS
  WAITING_MATERIALS
  READY
  SHIPPED
  COMPLETED
  CANCELED
}

enum OrderPriority {
  NORMAL
  URGENT
}

enum StockMovementType {
  IN
  OUT
  ADJUST
}

enum AddOnCostType {
  FIXED
  PER_ITEM
  PERCENT
}

enum MaterialUnitType {
  SHEET
  M2
}

enum MaterialCategory {
  PLYWOOD
  MDF
  ACRYLIC
  MIRROR_ACRYLIC
  OTHER
}

enum TemplateFieldType {
  TEXT
  NUMBER
  SELECT
  BOOLEAN
}

enum TemplateRuleType {
  FIXED_BASE
  PER_CHARACTER
  PER_CM2
  PER_ITEM
  LAYER_MULTIPLIER
  ADD_ON_LINK
}

enum SalesChannel {
  WOOCOMMERCE
  ETSY
  CSV
}

enum StoreConnectionStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

enum ExternalOrderProcessedState {
  NEW
  MAPPED
  CREATED_INTERNAL
  NEEDS_REVIEW
  ERROR
  IGNORED
}

enum ExternalProductPricingMode {
  USE_TEMPLATE_RULES
  EXTERNAL_PRICE_IGNORE
  PRICE_OVERRIDE
}

enum ExternalSyncStatus {
  SUCCESS
  FAILED
}

enum BatchStatus {
  PLANNED
  READY
  IN_PROGRESS
  PAUSED
  DONE
  CANCELED
}

enum BatchPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum BatchType {
  TEMPLATE_RUN
  MIXED
  CUSTOM
}

enum BatchTaskStatus {
  TODO
  DOING
  DONE
}

enum TodayQueueEntityType {
  BATCH
  ORDER_ITEM
}

enum OffcutShapeType {
  RECTANGLE
  IRREGULAR
}

enum OffcutCondition {
  GOOD
  OK
  DAMAGED
}

enum OffcutStatus {
  AVAILABLE
  RESERVED
  USED
  DISCARDED
}

enum OffcutSource {
  MANUAL
  FROM_ORDER_ITEM
  FROM_BATCH
}

enum OffcutUsageType {
  FULL
  PARTIAL
}

model User {
  id        String           @id @default(cuid())
  email     String           @unique
  password  String
  name      String
  role      UserRole         @default(WORKER)
  plan      UserPlan         @default(FREE)
  wpUserId  String?          @unique
  subscriptionType   SubscriptionType?
  subscriptionStatus SubscriptionStatus?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  timeLogs      TimeLog[]
  activityLogs  OrderActivityLog[]
  batchTasksAssigned BatchTask[]
  offcutsCreated      Offcut[]        @relation("UserCreatedOffcuts")
  offcutUsages        OffcutUsage[]   @relation("UserOffcutUsages")
  offcutReservations  OffcutReservation[] @relation("UserOffcutReservations")
  identityLinks       UserIdentityLink[]
  usageEvents         UsageEvent[]
  entitlement         UserEntitlement?
  adminAuditLogs      AdminAuditLog[]   @relation("AdminAuditLogs")
  adminAuditTargets   AdminAuditLog[]   @relation("AdminAuditTargets")
}

// Identity provider types for SSO linking
enum IdentityProvider {
  WORDPRESS
  // Future: GOOGLE, GITHUB, etc.
}

// Links a local User to an external identity (e.g., WordPress user)
model UserIdentityLink {
  id             String           @id @default(cuid())
  userId         String
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider       IdentityProvider
  externalUserId String           // e.g., WordPress user ID
  externalEmail  String?
  displayName    String?
  metadata       Json?            // Additional provider-specific data
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([provider, externalUserId])
  @@index([userId])
}

// Plan names matching the shared entitlements schema
enum PlanName {
  GUEST
  FREE
  STARTER
  PRO
  LIFETIME
}

// Snapshot of workspace entitlements at a point in time
// Used for audit trail and offline entitlements validation
model WorkspacePlanSnapshot {
  id                  String    @id @default(cuid())
  wpUserId            String    // WordPress user ID that owns this workspace
  plan                PlanName
  entitlementsVersion String    // e.g., "1.0"
  featuresJson        Json      // FeatureFlags snapshot
  limitsJson          Json      // EntitlementLimits snapshot
  validUntil          DateTime? // Subscription expiry if applicable
  fetchedAt           DateTime  @default(now())
  createdAt           DateTime  @default(now())

  @@index([wpUserId, fetchedAt])
}

model WpWebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  payloadJson Json
  createdAt   DateTime @default(now())
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
  quotes    Quote[]
}

model Material {
  id                 String             @id @default(cuid())
  name               String
  category           MaterialCategory
  thicknessMm        Int
  unitType           MaterialUnitType
  costPerSheet       Decimal?          @db.Decimal(10, 2)
  costPerM2          Decimal?          @db.Decimal(10, 2)
  sheetWidthMm       Int?
  sheetHeightMm      Int?
  stockQty           Int               @default(0)
  lowStockThreshold  Int               @default(0)
  defaultWastePercent Float?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  orderItems         OrderItem[]
  stockMovements     StockMovement[]
  defaultForTemplates ProductTemplate[]
  defaultForVariants  TemplateVariant[]
  templateProducts    TemplateProduct[]
  externalProductMappings ExternalProductMapping[]
  defaultBatches      ProductionBatch[]
  offcuts             Offcut[]
}

enum LaserMachineType {
  DIODE
  CO2
  FIBER
  GALVO
}

enum MachineConnectionType {
  RUIDA
  GRBL
  LIGHTBURN_BRIDGE
  GLOWFORGE_CLOUD
  MANUAL
}

enum MachineConnectionStatus {
  ONLINE
  OFFLINE
  BUSY
  ERROR
}

enum LaserJobStatus {
  DRAFT
  QUEUED
  VALIDATING
  SENDING
  CUTTING
  ENGRAVING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum LaserJobPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  PAUSED
  EXPIRED
  DELETED
}

enum ListingPlatform {
  ETSY
  SHOPIFY
  WOOCOMMERCE
  AMAZON_HANDMADE
  EBAY
  INTERNAL
}

model Machine {
  id                  String                  @id @default(cuid())
  name                String
  hourlyCost          Decimal?                @db.Decimal(10, 2)
  // Laser machine integration fields
  machineType         LaserMachineType?
  connectionType      MachineConnectionType?
  connectionStatus    MachineConnectionStatus @default(OFFLINE)
  ipAddress           String?
  port                Int?
  usbBridgePath       String?
  bedWidthMm          Int?
  bedHeightMm         Int?
  maxPowerW           Int?
  minPowerW           Int?
  maxSpeedMmS         Int?
  accelerationMmS2    Int?
  homePosition        String?                 // "top-left", "bottom-left"
  materialPresetsJson Json?                   // Array of { material, speed, power, passes }
  credentialsJson     Json?                   // Encrypted connection credentials
  lastPingAt          DateTime?
  lastJobAt           DateTime?
  firmwareVersion     String?
  userId              String?                 // Owner of this machine profile
  isShared            Boolean                 @default(false)
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt

  laserJobs           LaserJob[]

  @@index([userId])
  @@index([connectionStatus])
}

model LaserJob {
  id                  String          @id @default(cuid())
  machineId           String
  machine             Machine         @relation(fields: [machineId], references: [id])
  userId              String
  status              LaserJobStatus  @default(DRAFT)
  priority            LaserJobPriority @default(NORMAL)
  // Job content
  jobName             String
  productType         String?
  materialId          String?
  materialLabel       String?
  thicknessMm         Float?
  // SVG data
  cutSvgUrl           String?
  engraveSvgUrl       String?
  scoreSvgUrl         String?
  combinedSvgUrl      String?
  gcodeUrl            String?          // Generated gcode for GRBL machines
  // Machine parameters
  speedMmS            Int?
  powerPct            Int?
  passes              Int?             @default(1)
  kerfMm              Float?
  // Dimensions
  jobWidthMm          Float?
  jobHeightMm         Float?
  bedPositionX        Float?           @default(0)
  bedPositionY        Float?           @default(0)
  // Timing
  estimatedTimeSec    Int?
  actualTimeSec       Int?
  startedAt           DateTime?
  completedAt         DateTime?
  // Progress
  progressPct         Int              @default(0)
  currentOperation    String?          // "engraving", "cutting", "scoring"
  // Safety validation
  safetyValidated     Boolean          @default(false)
  safetyWarningsJson  Json?
  // Cost tracking
  materialCost        Decimal?         @db.Decimal(10, 2)
  machineCost         Decimal?         @db.Decimal(10, 2)
  totalCost           Decimal?         @db.Decimal(10, 2)
  // Error handling
  retryCount          Int              @default(0)
  maxRetries          Int              @default(3)
  errorMessage        String?
  errorCode           String?
  // Metadata
  sourceArtifactId    String?          // Link to Photo Product AI artifact
  productionBatchId   String?
  metadataJson        Json?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@index([machineId, status])
  @@index([userId, createdAt])
  @@index([status, priority])
  @@index([productionBatchId])
}

model MarketplaceListing {
  id                  String          @id @default(cuid())
  userId              String
  platform            ListingPlatform
  connectionId        String?         // StoreConnection reference
  // Listing content
  title               String
  description         String          @db.Text
  tagsJson            Json?           // String array
  category            String?
  // Product info
  productType         String?
  materialLabel       String?
  sizeMm              String?         // "200x150"
  // Pricing
  price               Decimal?        @db.Decimal(10, 2)
  currency            String          @default("USD")
  costOfGoods         Decimal?        @db.Decimal(10, 2)
  profitMargin        Float?
  // SKU
  sku                 String?
  quantity            Int             @default(999)
  // Media
  mockupUrlsJson      Json?           // Array of mockup image URLs
  previewPngUrl       String?
  // External
  externalListingId   String?
  externalUrl         String?
  externalStatus      String?
  // Status
  status              ListingStatus   @default(DRAFT)
  publishedAt         DateTime?
  // SEO
  seoKeywordsJson     Json?
  // Source
  sourceArtifactId    String?         // Link to Photo Product AI artifact
  productionInfoJson  Json?           // Production metadata from AI pipeline
  metadataJson        Json?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([userId, status])
  @@index([platform, status])
  @@index([connectionId])
  @@index([sku])
}

model BusinessAnalyticsSnapshot {
  id                  String   @id @default(cuid())
  userId              String
  periodStart         DateTime
  periodEnd           DateTime
  periodType          String   // "daily", "weekly", "monthly"
  // Production metrics
  totalJobsCompleted  Int      @default(0)
  totalJobsFailed     Int      @default(0)
  totalMachineTimeSec Int      @default(0)
  machineUtilization  Float?   // 0-1
  // Financial metrics
  totalRevenue        Decimal? @db.Decimal(12, 2)
  totalCosts          Decimal? @db.Decimal(12, 2)
  totalProfit         Decimal? @db.Decimal(12, 2)
  avgProfitMargin     Float?
  // Product metrics
  topProductsJson     Json?    // Array of { productType, count, revenue }
  topMaterialsJson    Json?    // Array of { material, count, cost }
  // Marketplace metrics
  totalListingsActive Int      @default(0)
  totalOrdersReceived Int      @default(0)
  // Efficiency
  avgJobTimeSec       Int?
  materialWastePct    Float?
  // Bottlenecks
  bottlenecksJson     Json?    // Array of { type, description, severity }
  createdAt           DateTime @default(now())

  @@index([userId, periodType, periodStart])
  @@unique([userId, periodType, periodStart])
}

model AddOn {
  id        String        @id @default(cuid())
  name      String
  costType  AddOnCostType
  value     Decimal       @db.Decimal(10, 2)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model Order {
  id          String        @id @default(cuid())
  customerId  String
  customer    Customer      @relation(fields: [customerId], references: [id])
  seasonId    String?
  season      Season?       @relation(fields: [seasonId], references: [id])
  status      OrderStatus   @default(NEW)
  priority    OrderPriority @default(NORMAL)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  items       OrderItem[]
  files       File[]
  activityLog OrderActivityLog[]
  externalLinks InternalOrderExternalLink[]
}

model OrderItem {
  id                 String      @id @default(cuid())
  orderId            String
  order              Order       @relation(fields: [orderId], references: [id])
  title              String
  materialId         String?
  material           Material?   @relation(fields: [materialId], references: [id])
  quantity           Int
  widthMm            Int?
  heightMm           Int?
  customizationText  String?
  estimatedMinutes   Int?
  priceSnapshotJson  Json?
  templateId         String?
  template           ProductTemplate?   @relation(fields: [templateId], references: [id])
  templateVariantId  String?
  templateVariant    TemplateVariant?   @relation(fields: [templateVariantId], references: [id])
  templateProductId   String?
  templateProduct     TemplateProduct?  @relation(fields: [templateProductId], references: [id])
  personalizationJson Json?
  derivedFieldsJson   Json?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  files               File[]
  timeLogs            TimeLog[]
  batchLinks          BatchItemLink[]
  todayQueuePins      TodayQueuePin[]
  offcutUsages        OffcutUsage[]
  offcutReservations  OffcutReservation[]
}

model TemplateCategory {
  id        String           @id @default(cuid())
  name      String
  slug      String           @unique
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  templates ProductTemplate[]
}

model ProductTemplate {
  id                String                        @id @default(cuid())
  name              String
  slug              String                        @unique
  categoryId        String?
  category          TemplateCategory?             @relation(fields: [categoryId], references: [id])
  defaultMaterialId String?
  defaultMaterial   Material?                     @relation(fields: [defaultMaterialId], references: [id])
  baseWidthMm       Int?
  baseHeightMm      Int?
  layersCount       Int?
  description       String?
  isActive          Boolean                       @default(true)
  createdAt         DateTime                      @default(now())
  updatedAt         DateTime                      @updatedAt

  variants          TemplateVariant[]
  fields            TemplatePersonalizationField[]
  pricingRules      TemplatePricingRule[]
  orderItems        OrderItem[]
  templateProducts  TemplateProduct[]
  externalProductMappings ExternalProductMapping[]
  materialHints     TemplateMaterialHint[]
}

model TemplateVariant {
  id                String           @id @default(cuid())
  templateId        String
  template          ProductTemplate  @relation(fields: [templateId], references: [id])
  name              String
  defaultMaterialId String?
  defaultMaterial   Material?        @relation(fields: [defaultMaterialId], references: [id])
  widthMm           Int?
  heightMm          Int?
  isActive          Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  pricingRules      TemplatePricingRule[]
  orderItems        OrderItem[]
  templateProducts  TemplateProduct[]
  externalProductMappings ExternalProductMapping[]
  defaultBatches    ProductionBatch[]
}

model TemplateProduct {
  id                 String           @id @default(cuid())
  name               String
  templateId         String
  template           ProductTemplate  @relation(fields: [templateId], references: [id])
  variantId          String?
  variant            TemplateVariant? @relation(fields: [variantId], references: [id])
  materialId         String?
  material           Material?        @relation(fields: [materialId], references: [id])
  defaultQuantity    Int              @default(1)
  personalizationJson Json?
  priceOverride      Decimal?         @db.Decimal(10, 2)
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  orderItems         OrderItem[]
  externalProductMappings ExternalProductMapping[]

  @@index([templateId])
  @@index([variantId])
  @@index([materialId])
}

model TemplatePersonalizationField {
  id                     String           @id @default(cuid())
  templateId             String
  template               ProductTemplate  @relation(fields: [templateId], references: [id])
  key                    String
  label                  String
  fieldType              TemplateFieldType
  required               Boolean          @default(false)
  minNumber              Float?
  maxNumber              Float?
  maxLength              Int?
  optionsJson            Json?
  affectsPricing         Boolean          @default(false)
  affectsProductionNotes Boolean          @default(false)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
}

model TemplatePricingRule {
  id             String           @id @default(cuid())
  templateId     String
  template       ProductTemplate  @relation(fields: [templateId], references: [id])
  variantId      String?
  variant        TemplateVariant? @relation(fields: [variantId], references: [id])
  ruleType       TemplateRuleType
  value          Float
  appliesWhenJson Json?
  priority       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([templateId])
  @@index([variantId])
}

model Quote {
  id          String   @id @default(cuid())
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  dataJson    Json
  createdAt   DateTime @default(now())
}

model File {
  id           String     @id @default(cuid())
  orderId      String?
  order        Order?     @relation(fields: [orderId], references: [id])
  orderItemId  String?
  orderItem    OrderItem? @relation(fields: [orderItemId], references: [id])
  url          String
  mime         String
  size         Int
  createdAt    DateTime   @default(now())
}

model StockMovement {
  id          String            @id @default(cuid())
  materialId  String
  material    Material          @relation(fields: [materialId], references: [id])
  type        StockMovementType
  qty         Int
  note        String?
  createdAt   DateTime          @default(now())
}

model TimeLog {
  id              String    @id @default(cuid())
  orderItemId     String
  orderItem       OrderItem @relation(fields: [orderItemId], references: [id])
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  startAt         DateTime
  endAt           DateTime?
  durationMinutes Int?
  createdAt       DateTime  @default(now())
}

model OrderActivityLog {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id])
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  field      String
  oldValue   String?
  newValue   String?
  createdAt  DateTime @default(now())
}

model StoreConnection {
  id              String                     @id @default(cuid())
  channel         SalesChannel
  name            String
  status          StoreConnectionStatus      @default(DISCONNECTED)
  credentialsJson Json?
  lastSyncAt      DateTime?
  settingsJson    Json?
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt

  productMappings ExternalProductMapping[]
  externalOrders  ExternalOrder[]
  orderLinks      InternalOrderExternalLink[]
  syncLogs        ExternalSyncLog[]

  @@index([channel])
}

model ExternalProductMapping {
  id                       String                      @id @default(cuid())
  connectionId             String
  connection               StoreConnection             @relation(fields: [connectionId], references: [id])
  externalProductId        String
  externalProductName      String
  templateId               String
  template                 ProductTemplate             @relation(fields: [templateId], references: [id])
  variantId                String?
  variant                  TemplateVariant?            @relation(fields: [variantId], references: [id])
  materialId               String?
  material                 Material?                   @relation(fields: [materialId], references: [id])
  templateProductId        String?
  templateProduct          TemplateProduct?            @relation(fields: [templateProductId], references: [id])
  personalizationMappingJson Json?
  pricingMode              ExternalProductPricingMode  @default(USE_TEMPLATE_RULES)
  priceOverride            Decimal?                    @db.Decimal(10, 2)
  isActive                 Boolean                     @default(true)
  createdAt                DateTime                    @default(now())
  updatedAt                DateTime                    @updatedAt

  @@unique([connectionId, externalProductId])
  @@index([connectionId])
  @@index([templateId])
}

model OffcutTag {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  offcutLinks OffcutTagsLink[]
}

model Offcut {
  id                   String           @id @default(cuid())
  materialId           String
  material             Material         @relation(fields: [materialId], references: [id])
  thicknessMm          Int
  shapeType            OffcutShapeType
  widthMm              Int?
  heightMm             Int?
  boundingBoxWidthMm   Int?
  boundingBoxHeightMm  Int?
  estimatedAreaMm2     Int?
  quantity             Int             @default(1)
  locationLabel        String?
  condition            OffcutCondition @default(GOOD)
  status               OffcutStatus    @default(AVAILABLE)
  source               OffcutSource    @default(MANUAL)
  notes                String?
  createdByUserId      String?
  createdByUser        User?           @relation("UserCreatedOffcuts", fields: [createdByUserId], references: [id])
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  deletedAt            DateTime?

  usages        OffcutUsage[]
  reservations  OffcutReservation[]
  tags          OffcutTagsLink[]

  @@index([materialId, thicknessMm, status])
  @@index([status])
  @@index([locationLabel])
}

model OffcutTagsLink {
  offcutId String
  offcut   Offcut   @relation(fields: [offcutId], references: [id])
  tagId    String
  tag      OffcutTag @relation(fields: [tagId], references: [id])

  @@id([offcutId, tagId])
}

model OffcutUsage {
  id              String           @id @default(cuid())
  offcutId        String
  offcut          Offcut           @relation(fields: [offcutId], references: [id])
  orderItemId     String?
  orderItem       OrderItem?       @relation(fields: [orderItemId], references: [id])
  batchId         String?
  batch           ProductionBatch? @relation(fields: [batchId], references: [id])
  usedAreaMm2     Int?
  usedWidthMm     Int?
  usedHeightMm    Int?
  usageType       OffcutUsageType
  notes           String?
  createdByUserId String?
  createdByUser   User?            @relation("UserOffcutUsages", fields: [createdByUserId], references: [id])
  createdAt       DateTime         @default(now())

  @@index([offcutId])
  @@index([orderItemId])
  @@index([batchId])
}

model OffcutReservation {
  id                String           @id @default(cuid())
  offcutId          String
  offcut            Offcut           @relation(fields: [offcutId], references: [id])
  orderItemId       String?
  orderItem         OrderItem?       @relation(fields: [orderItemId], references: [id])
  batchId           String?
  batch             ProductionBatch? @relation(fields: [batchId], references: [id])
  reservedByUserId  String
  reservedByUser    User             @relation("UserOffcutReservations", fields: [reservedByUserId], references: [id])
  reservedUntil     DateTime?
  createdAt         DateTime         @default(now())

  @@index([offcutId])
  @@index([orderItemId])
  @@index([batchId])
}

model ExternalOrder {
  id                   String                        @id @default(cuid())
  connectionId         String
  connection           StoreConnection                @relation(fields: [connectionId], references: [id])
  externalOrderId      String
  externalOrderNumber  String
  externalStatus       String?
  currency             String?
  totalsJson           Json?
  customerSnapshotJson Json?
  rawPayloadJson       Json?
  importedAt           DateTime                      @default(now())
  processedState       ExternalOrderProcessedState   @default(NEW)
  errorMessage         String?

  items                ExternalOrderItem[]
  orderLinks           InternalOrderExternalLink[]
  syncLogs             ExternalSyncLog[]

  @@unique([connectionId, externalOrderId])
  @@index([connectionId])
  @@index([processedState])
}

model ExternalOrderItem {
  id               String        @id @default(cuid())
  externalOrderId  String
  externalOrder    ExternalOrder @relation(fields: [externalOrderId], references: [id])
  externalProductId String?
  title            String
  quantity         Int
  unitPrice        Decimal?      @db.Decimal(10, 2)
  optionsJson      Json?
  rawPayloadJson   Json?
}

model InternalOrderExternalLink {
  id              String        @id @default(cuid())
  internalOrderId String
  internalOrder   Order         @relation(fields: [internalOrderId], references: [id])
  externalOrderId String
  externalOrder   ExternalOrder @relation(fields: [externalOrderId], references: [id])
  channel         SalesChannel
  connectionId    String
  connection      StoreConnection @relation(fields: [connectionId], references: [id])
  createdAt       DateTime       @default(now())

  @@unique([internalOrderId, externalOrderId])
  @@index([connectionId])
}

model ExternalSyncLog {
  id             String            @id @default(cuid())
  connectionId   String
  connection     StoreConnection   @relation(fields: [connectionId], references: [id])
  externalOrderId String
  externalOrder  ExternalOrder     @relation(fields: [externalOrderId], references: [id])
  action         String
  status         ExternalSyncStatus
  errorMessage   String?
  createdAt      DateTime          @default(now())

  @@index([connectionId, createdAt])
  @@index([externalOrderId, createdAt])
}

model Season {
  id        String   @id @default(cuid())
  name      String
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders  Order[]
  batches ProductionBatch[]
}

model ProductionBatch {
  id               String          @id @default(cuid())
  seasonId         String?
  season           Season?         @relation(fields: [seasonId], references: [id])
  name             String
  batchType        BatchType
  status           BatchStatus     @default(PLANNED)
  priority         BatchPriority   @default(NORMAL)
  targetDate       DateTime?
  defaultMaterialId String?
  defaultMaterial  Material?       @relation(fields: [defaultMaterialId], references: [id])
  defaultVariantId String?
  defaultVariant   TemplateVariant? @relation(fields: [defaultVariantId], references: [id])
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  items            BatchItemLink[]
  tasks            BatchTask[]
  todayQueuePins   TodayQueuePin[]
  offcutUsages     OffcutUsage[]
  offcutReservations OffcutReservation[]

  @@index([status, targetDate])
}

model BatchItemLink {
  id          String     @id @default(cuid())
  batchId     String
  batch       ProductionBatch @relation(fields: [batchId], references: [id])
  orderItemId String
  orderItem   OrderItem  @relation(fields: [orderItemId], references: [id])
  createdAt   DateTime   @default(now())

  @@unique([batchId, orderItemId])
  @@index([orderItemId])
}

model BatchTask {
  id             String         @id @default(cuid())
  batchId        String
  batch          ProductionBatch @relation(fields: [batchId], references: [id])
  title          String
  status         BatchTaskStatus @default(TODO)
  assignedUserId String?
  assignedUser   User?          @relation(fields: [assignedUserId], references: [id])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([batchId])
}

model TodayQueuePin {
  id          String              @id @default(cuid())
  entityType  TodayQueueEntityType
  batchId     String?
  batch       ProductionBatch?    @relation(fields: [batchId], references: [id])
  orderItemId String?
  orderItem   OrderItem?          @relation(fields: [orderItemId], references: [id])
  createdAt   DateTime            @default(now())

  @@index([entityType, createdAt])
}

model TemplateMaterialHint {
  id                      String           @id @default(cuid())
  templateId              String
  template                ProductTemplate  @relation(fields: [templateId], references: [id])
  avgAreaMm2PerItem       Float?
  avgSheetFractionPerItem Float?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  @@index([templateId])
}

model UsageEvent {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  toolKey   String
  action    UsageAction
  createdAt DateTime    @default(now())

  @@index([userId, toolKey, action, createdAt])
}

// ─────────────────────────────────────────────────────────────────────────────
// AI Credits & Entitlements System
// ─────────────────────────────────────────────────────────────────────────────

enum EntitlementPlan {
  INACTIVE
  TRIALING
  ACTIVE
  CANCELED
}

model UserEntitlement {
  id                    String          @id @default(cuid())
  userId                String          @unique
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                  EntitlementPlan @default(INACTIVE)
  trialStartedAt        DateTime?
  trialEndsAt           DateTime?
  aiCreditsTotal        Int             @default(0)
  aiCreditsUsed         Int             @default(0)
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  creditsGrantMonthlyAmount Int         @default(200)
  creditsNextGrantAt    DateTime?
  creditsLastGrantAt    DateTime?
  trialCreditsGrantedAt DateTime?
  // Community badge fields for Admin Edition
  communityBadge        CommunityBadge  @default(NONE)
  communityBadgeExpiresAt DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  aiUsageEvents         AiUsageEvent[]

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model AiUsageEvent {
  id               String           @id @default(cuid())
  userId           String
  entitlementId    String
  entitlement      UserEntitlement  @relation(fields: [entitlementId], references: [id], onDelete: Cascade)
  toolSlug         String
  actionType       String
  provider         String
  creditsConsumed  Int              @default(1)
  metadata         Json?
  createdAt        DateTime         @default(now())

  @@index([userId, createdAt])
  @@index([entitlementId, createdAt])
  @@index([toolSlug, actionType])
}

// ─────────────────────────────────────────────────────────────────────────────
// Artifacts System - Saved laser files from tools
// ─────────────────────────────────────────────────────────────────────────────

model Artifact {
  id            String    @id @default(cuid())
  userId        String
  toolSlug      String
  name          String
  description   String?
  fileSvgUrl    String?
  fileDxfUrl    String?
  filePdfUrl    String?
  previewPngUrl String?
  metaJson      Json?     // bboxMm, operations, thickness, kerf, notes, etc.
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId, createdAt])
  @@index([userId, toolSlug])
  @@index([toolSlug])
}

// ─────────────────────────────────────────────────────────────────────────────
// Guided Tours System
// ─────────────────────────────────────────────────────────────────────────────

enum TourStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

model TourProgress {
  id            String      @id @default(cuid())
  userId        String
  toolSlug      String
  status        TourStatus  @default(NOT_STARTED)
  lastStepIndex Int         @default(0)
  updatedAt     DateTime    @updatedAt

  @@unique([userId, toolSlug])
  @@index([userId])
  @@index([toolSlug])
}

// ─────────────────────────────────────────────────────────────────────────────
// User Feedback System
// ─────────────────────────────────────────────────────────────────────────────

enum FeedbackType {
  BUG
  FEATURE
}

enum FeedbackSeverity {
  LOW
  MEDIUM
  HIGH
}

enum FeedbackStatus {
  NEW
  TRIAGED
  PLANNED
  DONE
  CLOSED
}

// ─────────────────────────────────────────────────────────────────────────────
// Admin Edition Invite System
// ─────────────────────────────────────────────────────────────────────────────

enum AdminInviteStatus {
  PENDING
  REDEEMED
  REVOKED
  EXPIRED
}

enum CommunityBadge {
  NONE
  ADMIN_EDITION
  COMMUNITY_PARTNER
}

model AdminInvite {
  id                String            @id @default(uuid())
  email             String
  tokenHash         String            @unique
  tokenLast4        String
  plan              String            @default("PRO")
  creditsGrant      Int               @default(200)
  durationDays      Int               @default(30)
  status            AdminInviteStatus @default(PENDING)
  expiresAt         DateTime          // invite validity window
  redeemedAt        DateTime?
  redeemedByUserId  String?
  createdByUserId   String
  note              String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdByUserId])
}

model FeedbackTicket {
  id           String            @id @default(cuid())
  userId       String
  userEmail    String?
  type         FeedbackType
  toolSlug     String?
  pageUrl      String?
  title        String
  message      String            @db.Text
  severity     FeedbackSeverity?
  status       FeedbackStatus    @default(NEW)
  metadataJson Json?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  attachments  FeedbackAttachment[]

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([toolSlug])
}

model FeedbackAttachment {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    FeedbackTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  filename  String
  mimeType  String
  sizeBytes Int
  url       String
  createdAt DateTime @default(now())

  @@index([ticketId])
}

// ─────────────────────────────────────────────────────────────────────────────
// Admin Backend Audit Log
// ─────────────────────────────────────────────────────────────────────────────

enum AdminAuditAction {
  ADD_CREDITS
  FORCE_SYNC_WP
  UPDATE_USER
  DELETE_USER
}

model AdminAuditLog {
  id            String           @id @default(uuid())
  adminUserId   String
  adminUser     User             @relation("AdminAuditLogs", fields: [adminUserId], references: [id])
  targetUserId  String?
  targetUser    User?            @relation("AdminAuditTargets", fields: [targetUserId], references: [id])
  action        AdminAuditAction
  reason        String?
  deltaCredits  Int?
  payload       Json?
  ip            String?
  userAgent     String?
  createdAt     DateTime         @default(now())

  @@index([adminUserId, createdAt])
  @@index([targetUserId, createdAt])
  @@index([action])
}

// ─────────────────────────────────────────────────────────────────────────────
// Admin Messaging System
// ─────────────────────────────────────────────────────────────────────────────

model Message {
  id              String    @id @default(cuid())
  senderId        String
  senderEmail     String?
  senderName      String?
  recipientId     String?   // null = broadcast to all users
  recipientEmail  String?
  subject         String
  body            String    @db.Text
  isRead          Boolean   @default(false)
  readAt          DateTime?
  isArchived      Boolean   @default(false)
  parentId        String?   // for replies - references the original message
  parent          Message?  @relation("MessageReplies", fields: [parentId], references: [id])
  replies         Message[] @relation("MessageReplies")
  isBroadcast     Boolean   @default(false) // true if sent to all users
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([recipientId, isRead, createdAt])
  @@index([senderId, createdAt])
  @@index([parentId])
  @@index([isBroadcast, createdAt])
}

// ─────────────────────────────────────────────────────────────────────────────
// Laser Trend Scanner AI
// ─────────────────────────────────────────────────────────────────────────────

enum TrendSource {
  ETSY
  SHOPIFY
  AMAZON_HANDMADE
  PINTEREST
  TIKTOK
  INSTAGRAM
  REDDIT
  FACEBOOK
  MAKER_FORUM
  MANUAL
}

enum TrendCategory {
  PRODUCT_TYPE
  DESIGN_THEME
  ENGRAVING_STYLE
  MATERIAL
  SEASONAL
  NICHE
}

model TrendScan {
  id                  String          @id @default(cuid())
  userId              String
  scanType            String          @default("full") // full | quick | seasonal | niche
  status              String          @default("PENDING") // PENDING | SCANNING | ANALYZING | COMPLETE | FAILED

  // ── Aggregated trend data ──
  trendingProducts    Json?           // Array of trending product opportunities
  styleTrends         Json?           // Array of trending design styles
  seasonalForecast    Json?           // Upcoming seasonal demand predictions
  opportunityRadar    Json?           // Low-competition niches / product gaps
  priceInsights       Json?           // Pricing intelligence per category
  sourceBreakdown     Json?           // Per-source signal counts & quality

  // ── Metadata ──
  totalSignalsScanned Int             @default(0)
  totalTrendsFound    Int             @default(0)
  scanDurationMs      Int?
  aiModel             String?
  errorMessage        String?

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  opportunities       TrendOpportunity[]

  @@index([userId, createdAt])
  @@index([status])
}

model TrendOpportunity {
  id                  String          @id @default(cuid())
  scanId              String
  scan                TrendScan       @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // ── Core trend info ──
  title               String          // e.g. "Pet Memorial Plaques"
  description         String          @db.Text
  category            TrendCategory
  sources             TrendSource[]   // Which sources detected this
  keywords            String[]        // Search terms / hashtags

  // ── Scoring (0-100) ──
  trendStrength       Int             @default(0)
  growthVelocity      Int             @default(0)
  competitionDensity  Int             @default(0) // lower = better opportunity
  profitPotential     Int             @default(0)
  seasonalityScore    Int             @default(0)
  overallScore        Int             @default(0)

  // ── Product suggestions ──
  productIdeas        Json?           // Array of laser-ready product ideas
  recommendedSizes    Json?           // Suggested dimensions
  materialSuggestions String[]        // e.g. ["plywood-3mm", "acrylic-clear"]
  styleHints          String[]        // e.g. ["minimalist", "rustic"]
  priceRange          Json?           // { low, mid, high, premium }

  // ── Seasonal ──
  peakMonths          Int[]           // 1-12
  daysUntilPeak       Int?

  // ── Gap detection ──
  isGapOpportunity    Boolean         @default(false)
  demandLevel         String?         // HIGH | MEDIUM | LOW
  supplyLevel         String?         // HIGH | MEDIUM | LOW
  gapDescription      String?

  createdAt           DateTime        @default(now())

  @@index([scanId])
  @@index([category])
  @@index([overallScore])
}

model TrendSubscription {
  id                  String          @id @default(cuid())
  userId              String
  isActive            Boolean         @default(true)

  // ── What to watch ──
  watchCategories     TrendCategory[]
  watchKeywords       String[]
  minTrendStrength    Int             @default(60)

  // ── Notification prefs ──
  notifyInApp         Boolean         @default(true)
  notifyEmail         Boolean         @default(false)

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  alerts              TrendAlert[]

  @@index([userId, isActive])
}

model TrendAlert {
  id                  String            @id @default(cuid())
  subscriptionId      String
  subscription        TrendSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  userId              String

  // ── Alert content ──
  alertType           String            // NEW_TREND | SEASONAL_SPIKE | EMERGING_STYLE | GAP_FOUND
  title               String
  summary             String            @db.Text
  trendData           Json?             // Snapshot of the trend that triggered the alert

  isRead              Boolean           @default(false)
  readAt              DateTime?
  emailSent           Boolean           @default(false)

  createdAt           DateTime          @default(now())

  @@index([userId, isRead, createdAt])
  @@index([subscriptionId])
}
